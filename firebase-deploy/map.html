<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>모두의 모델하우스 - 지도</title>
    <link rel="stylesheet" href="/css/map.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Top Right Auth Buttons -->
    <div class="top-auth-buttons">
        <a href="/login" class="auth-btn" id="loginBtn">로그인</a>
        <a href="/signup" class="auth-btn" id="signupBtn">회원가입</a>
        <span class="separator" id="separator" style="display: none;">|</span>
        <a href="/admin" class="auth-btn admin-link" id="adminBtn" style="display: none;">관리자</a>
        <div class="user-info" id="userInfo" style="display: none;">
            <span id="username">사용자</span>
            <a href="/logout" class="auth-btn logout-btn">로그아웃</a>
        </div>
    </div>

    <!-- Search Bar -->
    <div class="search-container">
        <div class="search-input-container">
            <input type="text" class="search-input" placeholder="지역명 또는 모델하우스 이름을 입력하세요...">
            <button class="search-btn">
                <i class="fas fa-search"></i>
            </button>
        </div>
    </div>

    <!-- Map Container -->
    <div class="map-container">
        <div id="map"></div>
        
        <!-- Map Control Buttons -->
        <div class="map-controls">
            <button class="map-control-btn" onclick="resetMapView()" title="기본 보기로 복원">
                <i class="fas fa-home"></i>
            </button>
            <button class="map-control-btn" onclick="safeZoomToLevel(15)" title="가까이 보기 (안전한 줌)">
                <i class="fas fa-search-plus"></i>
            </button>
            <button class="map-control-btn" onclick="safeZoomToLevel(5)" title="멀리 보기 (안전한 줌)">
                <i class="fas fa-search-minus"></i>
            </button>
            <button class="map-control-btn" onclick="smoothZoomToLevel(12)" title="중간 보기 (부드러운 줌)">
                <i class="fas fa-expand-arrows-alt"></i>
            </button>
        </div>
        
        <!-- Model House Info Panel -->
        <div class="modelhouse-info" id="modelhouseInfo">
            <button class="close-info" onclick="closeInfo()">&times;</button>
            <h3><i class="fas fa-home"></i> <span id="infoTitle">모델하우스 정보</span></h3>
            
            <!-- QR 코드 섹션 -->
            <div class="qr-section">
                <img id="infoQrCode" src="https://placehold.co/150x150/000000/ffffff?text=QR" alt="QR 코드" class="qr-code">
            </div>
            
            <!-- 기본 정보 섹션 -->
            <div class="basic-info">
                <div class="info-item">
                    <i class="fas fa-map-marker-alt"></i>
                    <span id="infoAddress">주소: 서울특별시 강남구</span>
                    <button class="copy-btn" onclick="copyAddress()">주소복사</button>
                </div>
                
                <div class="info-item">
                    <i class="fas fa-phone"></i>
                    <span id="infoPhone">전화번호: 02-1234-5678</span>
                </div>
                
                <div class="info-item">
                    <i class="fas fa-building"></i>
                    <span id="infoType">유형: 단독주택</span>
                </div>
                
                <div class="info-item">
                    <i class="fas fa-dollar-sign"></i>
                    <span id="infoPrice">가격: 문의</span>
                </div>
                
                <div class="info-item description">
                    <i class="fas fa-info-circle"></i>
                    <span id="infoDescription">설명: 모델하우스 상세 설명</span>
                </div>
            </div>
            

            
            <!-- 이미지 갤러리 섹션 -->
            <div class="image-gallery" id="infoImageGallery">
                <h4>모델하우스 이미지</h4>
                <div class="gallery-images">
                    <!-- 이미지들이 동적으로 추가됩니다 -->
                </div>
            </div>
            
            <!-- 광고 섹션 -->
            <div class="advertisement-section">
                <h4>해당 광고:</h4>
                <div class="ad-banners">
                    <!-- 개발용: placehold.co 사용, 실제 서비스용: 로컬 이미지로 교체 권장 -->
                    <div class="ad-banner">
                        <!-- 실제 서비스용: <img src="/images/ad-banner-1.jpg" alt="광고 1"> -->
                        <img src="https://placehold.co/250x100/ff6b6b/ffffff?text=광고+배너+1" alt="광고 1">
                        <p>KPOP DEMON HUNTERS GOLDEN OFFICIAL LYRIC VIDEO</p>
                    </div>
                    <div class="ad-banner">
                        <!-- 실제 서비스용: <img src="/images/ad-banner-2.jpg" alt="광고 2"> -->
                        <img src="https://placehold.co/250x100/4ecdc4/ffffff?text=광고+배너+2" alt="광고 2">
                        <p>KPOP DEMON HUNTERS GOLDEN OFFICIAL LYRIC VIDEO</p>
                    </div>
                    <div class="ad-banner">
                        <!-- 실제 서비스용: <img src="/images/ad-banner-3.jpg" alt="광고 3"> -->
                        <img src="https://placehold.co/250x100/45b7d1/ffffff?text=광고+배너+3" alt="광고 3">
                        <p>KPOP DEMON HUNTERS GOLDEN OFFICIAL LYRIC VIDEO</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 이미지 모달 -->
    <div id="imageModal" class="image-modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <img id="modalImage" src="" alt="원본 이미지">
        </div>
    </div>
            
    </div>

    <!-- Kakao Maps API -->
    <script>
        // 인증 상태 확인 및 버튼 표시 함수
        function checkAuthStatus() {
            // 로컬 스토리지에서 인증 상태 확인
            const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
            const isAdmin = localStorage.getItem('isAdmin') === 'true';
            const currentUsername = localStorage.getItem('username') || '사용자';
            
            const loginBtn = document.getElementById('loginBtn');
            const signupBtn = document.getElementById('signupBtn');
            const separator = document.getElementById('separator');
            const adminBtn = document.getElementById('adminBtn');
            const userInfo = document.getElementById('userInfo');
            const usernameSpan = document.getElementById('username');
            
            if (isLoggedIn) {
                loginBtn.style.display = 'none';
                signupBtn.style.display = 'none';
                separator.style.display = 'inline-block';
                if (isAdmin) {
                    adminBtn.style.display = 'inline-block';
                } else {
                    adminBtn.style.display = 'none';
                }
                userInfo.style.display = 'block';
                usernameSpan.textContent = currentUsername;
            } else {
                loginBtn.style.display = 'inline-block';
                signupBtn.style.display = 'inline-block';
                separator.style.display = 'none';
                adminBtn.style.display = 'none';
                userInfo.style.display = 'none';
                usernameSpan.textContent = '사용자';
            }
        }
        
        // Kakao Maps API 로딩 상태 관리
        window.kakaoMapsLoaded = false;
        window.kakaoMapsError = false;
        window.kakaoMapsReady = false;
        window.mapInitialized = false; // 중복 초기화 방지 플래그
        
        // 지도 초기화 함수 (중복 방지)
        function safeInitMap() {
            if (window.mapInitialized) {
                console.log('지도가 이미 초기화되었습니다. 중복 초기화 방지.');
                return;
            }
            
            if (typeof initMap === 'function') {
                console.log('안전한 지도 초기화 시작');
                window.mapInitialized = true;
                setTimeout(() => initMap(), 100);
            }
        }
        
        // API 로딩 완료 콜백
        window.kakaoMapsCallback = function() {
            console.log('Kakao Maps API 로딩 완료 (콜백)');
            window.kakaoMapsLoaded = true;
            
            // API가 완전히 준비될 때까지 대기 (더 안전한 방식)
            const checkReady = setInterval(() => {
                if (typeof kakao !== 'undefined' && kakao.maps && kakao.maps.LatLng && typeof kakao.maps.LatLng === 'function') {
                    clearInterval(checkReady);
                    console.log('Kakao Maps API 완전히 준비됨 - LatLng 클래스 확인됨');
                    window.kakaoMapsReady = true;
                    
                    // 안전한 지도 초기화
                    safeInitMap();
                } else {
                    console.log('API 준비 대기 중...', {
                        kakao: typeof kakao,
                        maps: !!kakao?.maps,
                        LatLng: typeof kakao?.maps?.LatLng
                    });
                }
            }, 200); // 200ms마다 체크
            
            // 15초 후 타임아웃
            setTimeout(() => {
                if (checkReady) {
                    clearInterval(checkReady);
                    console.error('Kakao Maps API 준비 타임아웃');
                    window.kakaoMapsError = true;
                }
            }, 15000);
        };
        
        // API 로딩 실패 처리
        window.kakaoMapsErrorCallback = function() {
            console.error('Kakao Maps API 로딩 실패');
            window.kakaoMapsError = true;
            
            if (typeof showMapError === 'function') {
                showMapError();
            }
        };
    </script>
    
    <!-- Kakao Maps API 로딩 (autoload=true로 변경) -->
    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=91cb0bd7449dd781a29428e986969795&libraries=services" 
            onload="window.kakaoMapsCallback()" 
            onerror="window.kakaoMapsErrorCallback()"></script>
    
    <script>
        // 인증 상태에 따른 UI 업데이트 함수
        function updateAuthUI(isLoggedIn, isAdmin, currentUser) {
            const loginBtn = document.getElementById('loginBtn');
            const signupBtn = document.getElementById('signupBtn');
            const separator = document.getElementById('separator');
            const adminBtn = document.getElementById('adminBtn');
            const userInfo = document.getElementById('userInfo');
            const username = document.getElementById('username');
            
            if (isLoggedIn && currentUser) {
                loginBtn.style.display = 'none';
                signupBtn.style.display = 'none';
                separator.style.display = 'inline';
                userInfo.style.display = 'inline';
                username.textContent = currentUser;
                
                if (isAdmin) {
                    adminBtn.style.display = 'inline';
                } else {
                    adminBtn.style.display = 'none';
                }
            } else {
                loginBtn.style.display = 'inline';
                signupBtn.style.display = 'inline';
                separator.style.display = 'none';
                adminBtn.style.display = 'none';
                userInfo.style.display = 'none';
            }
        }
        
        // 페이지 로드 완료 후 지도 초기화
        window.addEventListener('load', function() {
            console.log('페이지 로드 완료, 지도 초기화 시작');
            
            // Thymeleaf에서 전달받은 사용자 정보로 UI 업데이트
            const isLoggedIn = /*[[${isLoggedIn}]]*/ false;
            const isAdmin = /*[[${isAdmin}]]*/ false;
            const currentUser = /*[[${currentUser}]]*/ null;
            
            updateAuthUI(isLoggedIn, isAdmin, currentUser);
            
            // 이미 초기화되었다면 건너뛰기
            if (window.mapInitialized) {
                console.log('지도가 이미 초기화되었습니다. 페이지 로드 이벤트 무시.');
                return;
            }
            
            // Kakao Maps API가 완전히 준비되었는지 확인
            if (window.kakaoMapsReady && typeof kakao !== 'undefined' && kakao.maps && kakao.maps.LatLng && typeof kakao.maps.LatLng === 'function') {
                console.log('Kakao Maps API 완전히 준비됨, 지도 초기화 시작');
                safeInitMap();
            } else if (window.kakaoMapsError) {
                console.error('Kakao Maps API 로딩 실패 상태');
                if (typeof showMapError === 'function') {
                    showMapError();
                }
            } else {
                console.log('Kakao Maps API 로딩 대기 중...');
                // API 로딩 대기
                const checkKakao = setInterval(function() {
                    if (window.mapInitialized) {
                        clearInterval(checkKakao);
                        console.log('지도가 이미 초기화되었습니다. 체크 중단.');
                        return;
                    }
                    
                    if (window.kakaoMapsReady && typeof kakao !== 'undefined' && kakao.maps && kakao.maps.LatLng && typeof kakao.maps.LatLng === 'function') {
                        clearInterval(checkKakao);
                        console.log('Kakao Maps API 완전히 준비됨, 지도 초기화 시작');
                        safeInitMap();
                    } else if (window.kakaoMapsError) {
                        clearInterval(checkKakao);
                        console.error('Kakao Maps API 로딩 실패');
                        if (typeof showMapError === 'function') {
                            showMapError();
                        }
                    } else {
                        console.log('API 준비 상태 체크 중...', {
                            ready: window.kakaoMapsReady,
                            kakao: typeof kakao,
                            maps: !!kakao?.maps,
                            LatLng: typeof kakao?.maps?.LatLng
                        });
                    }
                }, 300); // 300ms마다 체크
                
                // 25초 후 타임아웃
                setTimeout(() => {
                    if (checkKakao) {
                        clearInterval(checkKakao);
                        console.error('Kakao Maps API 로딩 타임아웃');
                        if (typeof showMapError === 'function') {
                            showMapError();
                        }
                    }
                }, 25000);
            }
        });
    </script>
    <script src="/js/map.js"></script>
    
    <!-- 백엔드 데이터 연동 스크립트 -->
    <script th:inline="javascript">
        // 백엔드에서 전달받은 모델하우스 데이터
        const modelHousesData = /*[[${modelHouses}]]*/ [];
        
        // 페이지 로드 시 모델하우스 데이터를 지도에 표시
        window.addEventListener('load', function() {
            if (modelHousesData && modelHousesData.length > 0) {
                console.log('백엔드 데이터 로드됨:', modelHousesData.length + '개의 모델하우스');
                // 지도 초기화 후 마커 추가
                if (window.addModelHouseMarkers) {
                    window.addModelHouseMarkers(modelHousesData);
                }
            } else {
                console.log('백엔드 데이터가 없습니다.');
            }
        });
    </script>
</body>
</html>
